name: Auto Packaging

on:
  push:
    paths:
      - 'unicast.m3u'
      - 'multicast-r2h.m3u'
      - 'multicast-nofcc.m3u'
  workflow_dispatch: 

permissions:
  contents: write

concurrency:
  group: playlist-update-group
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Get version info
      id: version
      run: |
        # èŽ·å–åŒ—äº¬æ—¶é—´
        export TZ='Asia/Shanghai'
        BEIJING_TIME=$(date +'%Y-%m-%d %H:%M:%S')
        
        # ç”Ÿæˆä¸€ä¸ªç®€çŸ­çš„ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚: 20231205-1530
        VERSION_TAG=$(date +'%Y%m%d-%H%M')
        
        # è®¾ç½®è¾“å‡ºå˜é‡ï¼Œä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
        echo "name=$VERSION_TAG" >> $GITHUB_OUTPUT
        echo "body=ðŸ“… æ›´æ–°æ—¶é—´: $BEIJING_TIME (åŒ—äº¬æ—¶é—´)" >> $GITHUB_OUTPUT

    - name: Create Release and Upload Assets
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåtagï¼Œå­˜åœ¨åˆ™åˆ é™¤
        if git rev-parse --verify "refs/tags/${{ steps.version.outputs.name }}" >/dev/null 2>&1; then
          echo "Tag ${{ steps.version.outputs.name }} already exists. Deleting it..."
          gh release delete "${{ steps.version.outputs.name }}" --yes || true
          git tag -d "${{ steps.version.outputs.name }}" || true
          git push origin ":refs/tags/${{ steps.version.outputs.name }}" || true
        fi
        
        # åˆ›å»º Release å¹¶ä¸Šä¼ æŒ‡å®šçš„ä¸‰ä¸ª .m3u æ–‡ä»¶ä½œä¸º Assets
        gh release create "${{ steps.version.outputs.name }}" \
          --title "Playlist Update ${{ steps.version.outputs.name }}" \
          --notes "${{ steps.version.outputs.body }}" \
          --latest \
          unicast.m3u multicast-r2h.m3u multicast-nofcc.m3u

